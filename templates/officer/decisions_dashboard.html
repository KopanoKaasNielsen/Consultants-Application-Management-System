{% extends 'base.html' %}

{% block title %}Decisions dashboard{% endblock %}

{% block content %}
<div class="page-stack">
  {% if messages %}
  <section class="data-card" aria-live="polite">
    <ul class="message-list">
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <section class="data-card">
    <div class="card-header">
      <h2>Applications requiring decisions</h2>
      <p class="card-subtitle">Review recently vetted submissions and record the final outcome.</p>
    </div>

    {% if consultants %}
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th scope="col">Consultant</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for consultant in consultants %}
          <tr>
            <td>
              <strong>{{ consultant.full_name }}</strong><br>
              <span class="muted">{{ consultant.business_name }}</span>
            </td>
            <td>{{ consultant.get_status_display|default:consultant.status|title }}</td>
            <td>
              <form method="post" class="inline-form">
                {% csrf_token %}
                <input type="hidden" name="consultant_id" value="{{ consultant.pk }}">
                {% if form.non_field_errors %}
                <div class="form-errors" role="alert">
                  {{ form.non_field_errors }}
                </div>
                {% endif %}

                {% with row_index=forloop.counter|stringformat:"s" %}
                {% with action_field=form.action %}
                {% with action_error_id="action-error-"|add:row_index %}
                <div class="form-field{% if action_field.errors %} has-error{% endif %}" role="group" aria-labelledby="{{ action_field.id_for_label }}-label"{% if action_field.errors %} aria-describedby="{{ action_error_id }}"{% endif %}>
                  <label id="{{ action_field.id_for_label }}-label" for="{{ action_field.id_for_label }}">{{ action_field.label }}</label>
                  {{ action_field }}
                  {% if action_field.errors %}
                  <div class="field-errors" id="{{ action_error_id }}" role="alert" aria-live="assertive">
                    {% for error in action_field.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
                {% endwith %}
                {% endwith %}

                {% with notes_field=form.notes %}
                {% with notes_error_id="notes-error-"|add:row_index %}
                <div class="form-field{% if notes_field.errors %} has-error{% endif %}" role="group" aria-labelledby="{{ notes_field.id_for_label }}-label"{% if notes_field.errors %} aria-describedby="{{ notes_error_id }}"{% endif %}>
                  <label id="{{ notes_field.id_for_label }}-label" for="{{ notes_field.id_for_label }}">{{ notes_field.label }}</label>
                  {{ notes_field }}
                  {% if notes_field.errors %}
                  <div class="field-errors" id="{{ notes_error_id }}" role="alert" aria-live="assertive">
                    {% for error in notes_field.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
                {% endwith %}
                {% endwith %}
                {% endwith %}
                <button type="submit" class="btn-primary">Record</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="card-subtitle">There are currently no vetted applications awaiting a decision.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
