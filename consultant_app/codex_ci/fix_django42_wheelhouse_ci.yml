name: "CI: Fix requirements for Django 4.2 LTS and build wheelhouse"
description: >
  Cloud/PR version executed by Codex GitHub App.
  Patches Django version, builds a wheelhouse, verifies it, and logs version.

steps:
  - name: "Set up Python environment"
    run: |
      python3 -m venv venv
      source venv/bin/activate
      pip install --upgrade pip setuptools wheel

  - name: "Patch requirements.txt for Django 4.2 LTS"
    run: |
      cd consultant_app
      if grep -q "Django==" requirements.txt; then
        sed -i 's/Django==.*/Django==4.2.16/' requirements.txt
      else
        echo "Django==4.2.16" >> requirements.txt
      fi
      echo "âœ… requirements.txt patched for Django 4.2.16 (LTS)"

  - name: "Build wheelhouse for offline use"
    run: |
      cd consultant_app
      mkdir -p wheelhouse
      pip wheel -r requirements.txt -w wheelhouse
      echo "âœ… Wheelhouse built successfully."

  - name: "Archive wheelhouse"
    run: |
      cd consultant_app
      tar -czf wheelhouse_django42_$(date +%Y%m%d).tar.gz wheelhouse
      echo "ğŸ Wheelhouse archive created."

  - name: "Verify offline installation"
    run: |
      echo "ğŸ§ª Verifying offline installation..."
      python3 -m venv test_venv
      source test_venv/bin/activate
      pip install --no-index --find-links=consultant_app/wheelhouse -r consultant_app/requirements.txt
      python -m django --version
      echo "âœ… Offline install verified."

  - name: "Summary"
    run: |
      echo "ğŸ¯ Django pinned to 4.2.16 (LTS)."
      echo "ğŸ“¦ Wheelhouse and archive ready for use."
