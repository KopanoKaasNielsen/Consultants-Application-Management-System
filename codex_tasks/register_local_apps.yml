task_name: Register Local Django Apps
actions:
  # 1Ô∏è‚É£ Ensure virtualenv active
  - type: shell
    cmd: |
      source venv/bin/activate || echo "‚ö†Ô∏è Activate your virtualenv manually before rerun"

  # 2Ô∏è‚É£ Append local apps into backend/settings/base.py if not present
  - type: shell
    cmd: |
      echo "üß© Ensuring local apps are registered in INSTALLED_APPS..."
      SETTINGS_FILE="backend/settings/base.py"

      declare -a LOCAL_APPS=(
        "consultant_app"
        "apps.certificates"
        "apps.consultants"
        "apps.decisions"
        "apps.security"
        "apps.users"
        "apps.vetting"
      )

      for app in "${LOCAL_APPS[@]}"; do
        if ! grep -q "$app" "$SETTINGS_FILE"; then
          sed -i "/INSTALLED_APPS = \[/a\    '$app'," "$SETTINGS_FILE"
          echo "‚úÖ Added $app to INSTALLED_APPS"
        else
          echo "‚úî $app already registered"
        fi
      done

  # 3Ô∏è‚É£ Run makemigrations and migrate
  - type: shell
    cmd: |
      echo "üèóÔ∏è Generating and applying migrations..."
      export DJANGO_SETTINGS_MODULE=backend.settings.dev
      python manage.py makemigrations --noinput || echo "‚ö†Ô∏è makemigrations failed"
      python manage.py migrate --noinput

  # 4Ô∏è‚É£ Verify PostgreSQL tables
  - type: shell
    cmd: |
      echo "üîç Listing tables after migration..."
      PGPASSWORD=password psql -U cams_user -h 127.0.0.1 -d cams -c "\dt" || echo "‚ö†Ô∏è Could not list tables"
