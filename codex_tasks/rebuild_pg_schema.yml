task_name: Rebuild PostgreSQL Schema from Current Models
actions:
  # 1Ô∏è‚É£ Ensure virtualenv active and Django env set
  - type: shell
    cmd: |
      source venv/bin/activate || echo "‚ö†Ô∏è Activate your virtualenv manually before rerun"
      export DJANGO_SETTINGS_MODULE=backend.settings.dev

  # 2Ô∏è‚É£ Clean up old migration files (leave __init__.py)
  - type: shell
    cmd: |
      echo "üßπ Cleaning previous migration files..."
      find apps -type f -path "*/migrations/*.py" ! -name "__init__.py" -delete
      find consultant_app -type f -path "*/migrations/*.py" ! -name "__init__.py" -delete
      echo "‚úÖ Old migrations removed."

  # 3Ô∏è‚É£ Regenerate migrations from all registered models
  - type: shell
    cmd: |
      echo "üß© Generating new migrations..."
      python manage.py makemigrations || echo "‚ö†Ô∏è makemigrations encountered issues"

  # 4Ô∏è‚É£ Apply migrations to PostgreSQL
  - type: shell
    cmd: |
      echo "üèóÔ∏è  Applying migrations to PostgreSQL..."
      python manage.py migrate --noinput

  # 5Ô∏è‚É£ Confirm new schema exists
  - type: shell
    cmd: |
      echo "üìã Listing tables to confirm schema..."
      PGPASSWORD=password psql -U cams_user -h 127.0.0.1 -d cams -c "\\dt"
