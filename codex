#!/usr/bin/env bash
# codex ‚Äì unified CLI for Codex automations
# Usage:
#   codex test
#   codex lint
#   codex review <PR_URL or PR_NUMBER>
#   codex fix <PR_URL or PR_NUMBER>
#   codex ci [PR_URL or PR_NUMBER]
#   codex custom "<natural language instruction>"

BASE_DIR="$HOME/CAMS/consultant_app"
VENV="$BASE_DIR/venv/bin/python"

case "$1" in
  test)
    echo "üß™ Running tests via Codex agent..."
    $VENV "$BASE_DIR/codex_agent.py" "Run pytest in this project and summarize failing tests."
    ;;

  lint)
    echo "üßπ Linting project via Codex agent..."
    $VENV "$BASE_DIR/codex_agent.py" "Run flake8 on the apps directory and summarize any warnings."
    ;;

  review)
    if [ -z "$2" ]; then
      echo "‚ùóUsage: codex review <PR_URL or PR_NUMBER>"
      exit 1
    fi

    arg="$2"
    # Detect current repo's GitHub remote URL
    remote_url=$(git config --get remote.origin.url 2>/dev/null)

    if [[ "$arg" =~ ^[0-9]+$ ]]; then
      # PR number only
      if [[ "$remote_url" =~ github.com[:/](.*)/(.*).git ]]; then
        owner="${BASH_REMATCH[1]}"
        repo="${BASH_REMATCH[2]}"
        pr_url="https://github.com/${owner}/${repo}/pull/${arg}"
      else
        echo "‚ö†Ô∏è  Not in a GitHub repository ‚Äî please provide full URL."
        exit 1
      fi
    else
      # Full URL provided
      pr_url="$arg"
    fi

    echo "üß† Reviewing PR: $pr_url"
    $VENV "$BASE_DIR/codex_review.py" "$pr_url"
    ;;

  fix)
    if [ -z "$2" ]; then
      echo "‚ùóUsage: codex fix <PR_URL or PR_NUMBER>"
      exit 1
    fi

    arg="$2"
    remote_url=$(git config --get remote.origin.url 2>/dev/null)
    if [[ "$arg" =~ ^[0-9]+$ ]]; then
      if [[ "$remote_url" =~ github.com[:/](.*)/(.*).git ]]; then
        owner="${BASH_REMATCH[1]}"
        repo="${BASH_REMATCH[2]}"
        pr_url="https://github.com/${owner}/${repo}/pull/${arg}"
      else
        echo "‚ö†Ô∏è  Not in a GitHub repo ‚Äî please give full URL."
        exit 1
      fi
    else
      pr_url="$arg"
    fi

    echo "üß© Applying GPT-5 Codex fixes for $pr_url ..."
    $VENV "$BASE_DIR/codex_fix.py" "$pr_url"
    ;;

  ci)
    echo "üß† Running Codex CI pipeline..."
    if [ -z "$2" ]; then
      echo "‚öôÔ∏è  Running local CI (tests + lint only)..."
      "$BASE_DIR/codex_ci_tasks.sh"
    else
      echo "üöÄ Running Codex CI for PR: $2"
      "$BASE_DIR/codex_ci_tasks.sh" "$2"
    fi
    ;;

  custom)
    shift
    echo "ü§ñ Executing custom Codex instruction: $*"
    $VENV "$BASE_DIR/codex_agent.py" "$*"
    ;;

    evaluate)
    echo "üß© Running full source + repo evaluation..."
    if [ -z "$2" ]; then
      $VENV "$BASE_DIR/codex_evaluate.py"
    else
      $VENV "$BASE_DIR/codex_evaluate.py" "$2"
    fi
    ;;

    task)
    if [ -z "$2" ]; then
      echo "‚ùóUsage: codex task <task-name>"
      exit 1
    fi
    echo "üß† Running Codex task: $2"
    $VENV "$BASE_DIR/codex_tasks.py" "$2"
    ;;
     



  *)
    echo "Usage: codex {test|lint|review|fix|ci|custom}"
    ;;
esac
